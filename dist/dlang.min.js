const fs=require("fs"),createId=e=>btoa(e);class DLang{constructor(e){this.lines=e.split("\n")}noHandler(){}dbGetDocUnsafeConditionRunner_(e,n,r){let t,s=e;n[s[0]]?s[0]=n[s[0]]:this.noHandler(),n[s[1]]?s[1]=n[s[1]]:this.noHandler();try{t=JSON.parse(fs.readFileSync(`unsafeDb/${s[0]}.json`))[s[1]]}catch(e){console.error(e)}if(r)return t}run(){let e=this.lines,n=!1,r=!1,t={};for(let i=0;i<e.length;i++){if("import 'jql:main/base.jql'"===e[i]&&(n=!0),"import 'jql:main/database.jql'"===e[i]&&(r=!0),e[i].includes("(")){let s,l=e[i].split("(")[0],o=e[i].replace("(","").replace(")","").replace(l,"");s=o.includes("'")?o.replace(/\'/g,""):t[o];let a="createUnsafeDB"===l&&!0===r,c="createDocument"===l&&!0===r,f="createProperty"===l&&!0===r,d="removeDocument"===l&&!0===r,h="removeDB"===l&&!0===r,p="removeProperty"===l&&!0===r,u="renameDocument"===l&&!0===r,y="renameProperty"===l&&!0===r,S="changeProperty"===l&&!0===r,D="getDocument"===l&&!0===r;if("print"===l&&!0===n)void 0===s?console.error(`${o} is not defined.`):console.log(s);else if(a){let e=[" ","+","=","-","!","@","#","$","%","^","&","*","(",")","{","[","]","}","|","\\",'"',"'",";",":","?","/",".",">","<",","];const n=n=>{let r=!1;for(let t=0;t<e.length;t++)if(n.includes(e[t])){r=!0;break}return r};if(n(s))throw TypeError("Unallowed letter in the given file name.");try{fs.writeFileSync(`unsafeDb/${s}.json`,JSON.stringify({id:createId(s)}))}catch(e){console.error(e)}}if(c){let e,n=s.split(", ")||s.split(",");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}e[n[1]]={},fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}if(f){let e,n=s.split(", ");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler(),t[n[2]]?n[2]=t[n[2]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}const r={};r[n[2]]=n[3],e[n[1]]=r,Object.assign(e[n[1]],r);try{fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}catch(e){console.error(e)}}if(d){let e,n=s.split(", ");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}delete e[n[1]],fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}if(h){let e=s.split(", ");t[e[0]]?e[0]=t[e[0]]:this.noHandler();try{fs.unlinkSync(`unsafeDb/${e[0]}.json`)}catch(e){console.error(e)}}if(p){let e,n=s.split(", ");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler(),t[n[2]]?n[2]=t[n[2]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}delete e[n[1]][n[2]];try{fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}catch(e){console.error(e)}}if(u){let e,n=s.split(", ")||s.split(",");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler(),t[n[2]]?n[2]=t[n[2]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}let r=e[n[1]];delete e[n[1]],e[n[2]]=r;try{fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}catch(e){console.error(e)}}if(y){let e,n=s.split(", ")||s.split(",");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler(),t[n[2]]?n[2]=t[n[2]]:this.noHandler(),t[n[3]]?n[3]=t[n[3]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}let r=e[n[1]][n[2]];delete e[n[1]][n[2]];let i={};i[n[3]]=r,Object.assign(e[n[1]],i);try{fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}catch(e){console.error(e)}}if(S){let e,n=s.split(", ")||s.split(",");t[n[0]]?n[0]=t[n[0]]:this.noHandler(),t[n[1]]?n[1]=t[n[1]]:this.noHandler(),t[n[2]]?n[2]=t[n[2]]:this.noHandler(),t[n[3]]?n[3]=t[n[3]]:this.noHandler();try{e=JSON.parse(fs.readFileSync(`unsafeDb/${n[0]}.json`))}catch(e){console.error(e)}e[n[1]][n[2]]=n[3];try{fs.writeFileSync(`unsafeDb/${n[0]}.json`,JSON.stringify(e))}catch(e){console.error(e)}}D&&this.dbGetDocUnsafeConditionRunner_(s.split(", ")||s.split(","),t,!1)}if(e[i].includes("var",0)){let n,r=["getDocument"];if(n=e[i].replace("var","").replace("=","").trim().split("'"),e[i].split("'")[0].includes("(")){let n=e[i].replace("var","").replace("=","").trim().split("'"),l=n[0].split("(")[0].split(" ")[2],o=n[0].split(" ")[0].trim(),a=[];if(!r.find((e=>e===l)))throw new Error(`${l} is not defined.`);for(let e=0;e<n.length;e++)if(n[e].includes("(")){var s=n[e].split("(")[1].replace(",","").trim();if(s.includes("'"))a.push(s);else{if(!t[s])throw new ReferenceError(`${s} is not defined.`);a.push(t[s])}}else{if(n[e].includes("'"))throw new ReferenceError(`${n[e]} is not defined.`);t[n[e]]?a.push(t[s]):")"===n[e]||a.push(n[e])}t[o]=this.dbGetDocUnsafeConditionRunner_(a,t,!0)}else t[n[0].trim()]=n[1]}e[i].includes("//",0)&&this.noHandler()}}}module.exports=DLang;
